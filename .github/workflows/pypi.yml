name: Publish Package and Release

on:
  workflow_run:
    workflows: ["CI"]
    types: [completed]

permissions:
  contents: write
  packages: write
  id-token: write

jobs:
  release:
    if: ${{ github.event.workflow_run.conclusion == 'success' && github.event.workflow_run.event == 'push' }}
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Find merged PR for commit (must target main)
        id: find_pr
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            // Use context (injected) rather than github.context to avoid undefined access
            const payload = typeof context !== 'undefined' ? context.payload : undefined;
            const sha = payload && payload.workflow_run && payload.workflow_run.head_sha ? payload.workflow_run.head_sha : process.env.GITHUB_SHA;
            if (!sha) {
              core.info('No SHA available in workflow_run payload or env; skipping.');
              core.setOutput('pr_number', '');
              return;
            }

            const prs = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'closed',
              per_page: 200
            });

            const merged = prs.data.find(p => p.merge_commit_sha === sha && p.merged_at && p.base && p.base.ref === 'main');
            if (!merged) {
              core.info(`No merged PR found for commit ${sha} targeting 'main'; skipping release.`);
              core.setOutput('pr_number', '');
              return;
            }

            core.setOutput('pr_number', String(merged.number));
            core.setOutput('labels', JSON.stringify(merged.labels.map(l => l.name)));
            core.setOutput('base', merged.base.ref);

      - name: Abort if not a merged PR into main
        if: steps.find_pr.outputs.pr_number == 'null' || steps.find_pr.outputs.pr_number == ''
        run: |
          echo "No merged PR targeting 'main' associated with this run; skipping release.";
          exit 78

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install semantic-release
        run: |
          python -m pip install --upgrade pip
          python -m pip install 'python-semantic-release[all]'

      - name: Run semantic-release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PYPI_API_TOKEN: ${{ secrets.PYPI_API_TOKEN }}
        run: |
          # Optional dry-run for verification:
          # python -m semantic_release version --dry-run
          python -m semantic_release publish
